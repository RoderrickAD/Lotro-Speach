name: ðŸ”¨ Build Windows EXE (Clean & Merged)

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  build_windows_exe:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Repository auschecken
      uses: actions/checkout@v4

    - name: ðŸ Python Setup (Version ${{ env.PYTHON_VERSION }})
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: âš™ï¸ SystemabhÃ¤ngigkeiten installieren
      run: |
        pip install pyinstaller
        pip install easyocr
        pip install torch torchaudio --index-url https://download.pytorch.org/whl/cu118
        pip install TTS
        pip install google-generativeai
        pip install -r requirements.txt

    - name: ðŸ§¬ Python-Skripte verschmelzen
      # Dieser Schritt verhindert Import-Fehler (ModuleNotFoundError), 
      # indem er alles in eine Datei packt.
      run: |
        $mergerScript = @"
        import os

        # Reihenfolge beachten: Utils -> Services -> Core -> Main
        file_order = ['utils.py', 'ocr_service.py', 'tts_service.py', 'core.py', 'main.py']
        
        # Diese Importe lÃ¶schen wir, da jetzt alles in einer Datei liegt
        local_imports = ['from utils', 'import utils', 'from ocr_service', 'import ocr_service', 
                         'from tts_service', 'import tts_service', 'from core', 'import core']

        combined_code = ["import sys\nimport os\n"]

        print("Verschmelze Dateien...")
        for fname in file_order:
            if os.path.exists(fname):
                print(f" -> {fname}")
                with open(fname, 'r', encoding='utf-8') as f:
                    for line in f:
                        # Wir entfernen Zeilen, die lokale Module importieren
                        if not any(line.strip().startswith(imp) for imp in local_imports):
                            combined_code.append(line)
            else:
                print(f"FEHLER: Datei {fname} nicht gefunden! Build Abbruch.")
                exit(1)

        with open('combined_app.py', 'w', encoding='utf-8') as f:
            f.writelines(combined_code)
        print("Erfolg: combined_app.py wurde erstellt.")
        "@

        $mergerScript | Out-File -FilePath merger.py -Encoding utf8
        python merger.py
      shell: pwsh

    - name: ðŸ“¦ EXE bauen
      run: |
        $buildScript = @"
        import PyInstaller.__main__
        import os
        
        work_dir = os.getcwd().replace('\\', '/')
        
        # Icon prÃ¼fen
        icon_path = os.path.join(work_dir, 'app_icon.ico')
        if os.path.exists(icon_path):
            icon_arg = ['--icon', icon_path.replace('\\', '/')]
        else:
            icon_arg = []

        args = [
            'combined_app.py',             # Wir nutzen die kombinierte Datei
            '--onefile',
            '--name=LOTRO_Voice_Companion',
            f'--paths={work_dir}',
            '--collect-all=pygame',
            '--clean',
            '--noconfirm',
            '--windowed'
        ] + icon_arg
        
        print("Starte PyInstaller...")
        PyInstaller.__main__.run(args)
        "@
        
        $buildScript | Out-File -FilePath builder.py -Encoding utf8
        python builder.py
      shell: pwsh

    - name: ðŸ“‚ PrÃ¼fen und Umbenennen
      run: |
        if (Test-Path "dist/LOTRO_Voice_Companion.exe") {
            Write-Host "Build erfolgreich!"
        } else {
            Write-Error "FEHLER: EXE wurde nicht erstellt."
            exit 1
        }
      shell: pwsh

    - name: ðŸ“¤ Artefakt hochladen
      uses: actions/upload-artifact@v4
      with:
        name: LOTRO-Voice-Companion-Windows-EXE
        path: dist/LOTRO_Voice_Companion.exe
