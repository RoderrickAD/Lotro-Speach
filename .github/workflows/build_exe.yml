name: ðŸ”¨ Build Windows Executable (Dynamic)

on:
  workflow_dispatch:
    # Wir brauchen keine manuellen Inputs mehr, das Skript macht alles automatisch.

env:
  PYTHON_VERSION: '3.11'

jobs:
  build_windows_exe:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Repository auschecken
      uses: actions/checkout@v4

    - name: ðŸ Python Setup (Version ${{ env.PYTHON_VERSION }})
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: âš™ï¸ SystemabhÃ¤ngigkeiten installieren
      run: |
        pip install pyinstaller
        pip install -r requirements.txt

    - name: ðŸ“¦ PyInstaller-Build (Automatisch & Dynamisch)
      id: build
      run: |
        Write-Host "ðŸ” Suche nach Python-Modulen im aktuellen Ordner..."
        
        # 1. Alle .py Dateien finden (auÃŸer main.py, das ist der Startpunkt)
        $pyFiles = Get-ChildItem -Filter "*.py" | Where-Object { $_.Name -ne "main.py" }
        
        # 2. String fÃ¼r Hidden Imports zusammenbauen
        $hiddenImports = ""
        foreach ($file in $pyFiles) {
            $name = $file.BaseName
            Write-Host "   -> Gefunden: $name"
            $hiddenImports += " --hidden-import=$name"
        }
        
        # 3. Der finale Befehl
        # --paths=.           : WICHTIG! Zwingt PyInstaller, im aktuellen Ordner zu suchen
        # --onefile           : Eine einzige EXE
        # --noconsole         : (Optional) Konsole ausblenden. Entferne dies, wenn du das schwarze Fenster sehen willst.
        # --collect-all pygame: Wichtig fÃ¼r Audio
        # --icon=app_icon.ico : Dein Ring-Icon
        
        $build_command = "pyinstaller main.py --onefile --paths=. $hiddenImports --collect-all pygame --icon=app_icon.ico"
        
        Write-Host "ðŸš€ Starte Build mit Befehl:"
        Write-Host $build_command
        
        # AusfÃ¼hren
        Invoke-Expression $build_command
        
        # Output-Variable setzen
        echo "EXE_NAME=main.exe" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: ðŸ“‚ Umbenennen der ausfÃ¼hrbaren Datei
      run: |
        # PrÃ¼fen, ob die Datei existiert, bevor wir sie umbenennen
        if (Test-Path "dist/main.exe") {
            Move-Item "dist/main.exe" "dist/LOTRO_Voice_Companion.exe"
            Write-Host "Datei erfolgreich umbenannt."
        } else {
            Write-Error "Build fehlgeschlagen: dist/main.exe wurde nicht gefunden."
            exit 1
        }
      shell: pwsh

    - name: ðŸ“¤ Artefakt hochladen
      uses: actions/upload-artifact@v4
      with:
        name: LOTRO-Voice-Companion-Windows-EXE
        path: dist/LOTRO_Voice_Companion.exe
