name: üî® Build Windows EXE (Spec File Strategy)

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  build_windows_exe:
    runs-on: windows-latest
    
    steps:
    - name: üì• Repository auschecken
      uses: actions/checkout@v4

    - name: üêç Python Setup (Version ${{ env.PYTHON_VERSION }})
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ‚öôÔ∏è Systemabh√§ngigkeiten installieren
      run: |
        pip install pyinstaller
        pip install -r requirements.txt

    - name: üîç Diagnose (Dateipr√ºfung)
      run: |
        # Wir pr√ºfen, ob die Datei wirklich da ist und wie sie geschrieben wird
        Get-ChildItem -Recurse | ForEach-Object { Write-Host $_.FullName }
      shell: pwsh

    - name: üìù Spec-File erstellen und Builden
      run: |
        $scriptContent = @"
        import PyInstaller.__main__
        import os
        
        # Arbeitsverzeichnis holen
        work_dir = os.getcwd()
        print(f'Work Dir: {work_dir}')

        # Icon Pfad pr√ºfen
        icon_path = os.path.join(work_dir, 'app_icon.ico')
        has_icon = os.path.exists(icon_path)
        icon_str = f"'{icon_path}'" if has_icon else 'None'

        # WICHTIG: Hier definieren wir den Inhalt der .spec Datei manuell.
        # Wir f√ºgen 'ocr_service' HARTCODIERT zu den hiddenimports hinzu.
        spec_content = f"""
        # -*- mode: python ; coding: utf-8 -*-

        block_cipher = None

        a = Analysis(
            ['main.py'],
            pathex=['{work_dir.replace("\\", "\\\\")}'],
            binaries=[],
            datas=[],
            # HIER IST DER FIX: Wir zwingen PyInstaller, diese Module einzubinden
            hiddenimports=['ocr_service', 'core', 'tts_service', 'utils', 'pygame'],
            hookspath=[],
            hooksconfig={{}},
            runtime_hooks=[],
            excludes=[],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=block_cipher,
            noarchive=False,
        )

        # Configs hinzuf√ºgen (falls vorhanden)
        if os.path.exists('config.json'):
            a.datas += [('config.json', '{work_dir.replace("\\", "\\\\")}\\\\config.json', 'DATA')]
        if os.path.exists('voice_mapping.json'):
            a.datas += [('voice_mapping.json', '{work_dir.replace("\\", "\\\\")}\\\\voice_mapping.json', 'DATA')]

        pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

        exe = EXE(
            pyz,
            a.scripts,
            a.binaries,
            a.zipfiles,
            a.datas,
            [],
            name='LOTRO_Voice_Companion',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            upx_exclude=[],
            runtime_tmpdir=None,
            console=False, 
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
            icon={icon_str}, 
        )
        """

        # Spec Datei schreiben
        with open('main.spec', 'w', encoding='utf-8') as f:
            f.write(spec_content)
        
        print("--- MAIN.SPEC WURDE ERSTELLT ---")
        print(spec_content)
        print("--------------------------------")

        # PyInstaller mit der Spec-Datei starten
        PyInstaller.__main__.run(['main.spec', '--clean', '--noconfirm'])
        "@
        
        $scriptContent | Out-File -FilePath builder.py -Encoding utf8
        python builder.py
      shell: pwsh

    - name: üìÇ Pr√ºfen und Umbenennen
      run: |
        if (Test-Path "dist/LOTRO_Voice_Companion.exe") {
            Write-Host "Build erfolgreich! Datei gefunden."
        } else {
            Write-Error "FEHLER: EXE wurde nicht erstellt."
            exit 1
        }
      shell: pwsh

    - name: üì§ Artefakt hochladen
      uses: actions/upload-artifact@v4
      with:
        name: LOTRO-Voice-Companion-Windows-EXE
        path: dist/LOTRO_Voice_Companion.exe
