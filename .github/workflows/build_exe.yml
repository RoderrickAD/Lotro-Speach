name: ðŸ”¨ Build Windows Executable (pyinstaller)

on:
  # Erlaubt die manuelle AusfÃ¼hrung Ã¼ber die GitHub Actions UI
  workflow_dispatch:
    inputs:
pyinstaller_flags:
        description: 'ZusÃ¤tzliche PyInstaller-Flags'
        required: false
        # Ã„NDERUNG HIER: Wir fÃ¼gen --hidden-import fÃ¼r alle deine Module hinzu
        default: '--onefile --hidden-import=ocr_service --hidden-import=tts_service --hidden-import=utils --hidden-import=core --collect-all pygame --add-data "templates;templates" --add-data "config.json;." --add-data "voice_mapping.json;."'
        
env:
  PYTHON_VERSION: '3.11'

jobs:
  build_windows_exe:
    runs-on: windows-latest
    
    steps:
    - name: ðŸ“¥ Repository auschecken
      uses: actions/checkout@v4

    - name: ðŸ Python Setup (Version ${{ env.PYTHON_VERSION }})
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: âš™ï¸ SystemabhÃ¤ngigkeiten installieren (PyInstaller)
      run: |
        pip install pyinstaller
        pip install -r requirements.txt
      # Anmerkung: Die `requirements.txt` muss alle ProjektabhÃ¤ngigkeiten enthalten.

    - name: ðŸ“¦ PyInstaller-Build ausfÃ¼hren
      id: build
      run: |
        # Wir bauen `main.py`
        $build_command = "pyinstaller main.py ${{ github.event.inputs.pyinstaller_flags }}"
        Write-Host "FÃ¼hre aus: $build_command"
        Invoke-Expression $build_command
        
        # Windows-Name fÃ¼r die EXE-Datei extrahieren
        $exe_name = "main.exe"
        if ($build_command -like "*--name*") {
          $match = $build_command | Select-String -Pattern "--name\s+([\w-]+)"
          if ($match) {
            $exe_name = "$($match.Matches.Groups[1].Value).exe"
          }
        }
        echo "EXE_NAME=$exe_name" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: ðŸ“‚ Umbenennen der ausfÃ¼hrbaren Datei
      run: |
        # Der Output-Ordner ist 'dist'
        Move-Item "dist/${{ steps.build.outputs.EXE_NAME }}" "dist/LOTRO_Voice_Companion.exe"
      shell: pwsh

    - name: ðŸ“¤ Artefakt hochladen
      uses: actions/upload-artifact@v4
      with:
        name: LOTRO-Voice-Companion-Windows-EXE
        path: dist/LOTRO_Voice_Companion.exe
        # Anmerkung: PyInstaller erstellt den 'dist'-Ordner
