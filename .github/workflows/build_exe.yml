name: üî® Build Windows EXE (Fixed Syntax)

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  build_windows_exe:
    runs-on: windows-latest
    
    steps:
    - name: üì• Repository auschecken
      uses: actions/checkout@v4

    - name: üêç Python Setup (Version ${{ env.PYTHON_VERSION }})
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ‚öôÔ∏è Systemabh√§ngigkeiten installieren
      run: |
        pip install pyinstaller
        pip install -r requirements.txt

    - name: üîç Diagnose (Dateipr√ºfung)
      run: |
        Get-ChildItem -Filter "*.py" | ForEach-Object { Write-Host "Gefunden: $($_.FullName)" }
      shell: pwsh

    - name: üìù Spec-File erstellen und Builden
      run: |
        $scriptContent = @"
        import PyInstaller.__main__
        import os
        
        # 1. Pfade vorbereiten (WICHTIG: Forward Slashes nutzen, um Backslash-Fehler zu vermeiden)
        work_dir = os.getcwd()
        safe_work_dir = work_dir.replace('\\', '/')
        
        print(f'Work Dir: {safe_work_dir}')

        # Icon Pfad pr√ºfen
        icon_path_raw = os.path.join(work_dir, 'app_icon.ico')
        if os.path.exists(icon_path_raw):
            # Auch hier: Slashes sicher machen
            safe_icon_path = icon_path_raw.replace('\\', '/')
            icon_str = f"'{safe_icon_path}'"
            print(f"Icon gefunden: {safe_icon_path}")
        else:
            icon_str = 'None'
            print("Kein Icon gefunden.")

        # 2. Spec-File Inhalt definieren
        # Wir nutzen jetzt die Variable {safe_work_dir}, die keine Backslashes mehr hat.
        spec_content = f"""
        # -*- mode: python ; coding: utf-8 -*-

        block_cipher = None

        a = Analysis(
            ['main.py'],
            pathex=['{safe_work_dir}'],
            binaries=[],
            datas=[],
            # HARTCODIERTE IMPORTS DAMIT OCR_SERVICE GEFUNDEN WIRD
            hiddenimports=['ocr_service', 'core', 'tts_service', 'utils', 'pygame'],
            hookspath=[],
            hooksconfig={{}},
            runtime_hooks=[],
            excludes=[],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=block_cipher,
            noarchive=False,
        )

        # Configs einbinden (wenn vorhanden)
        import os
        if os.path.exists('{safe_work_dir}/config.json'):
            a.datas += [('config.json', '{safe_work_dir}/config.json', 'DATA')]
        if os.path.exists('{safe_work_dir}/voice_mapping.json'):
            a.datas += [('voice_mapping.json', '{safe_work_dir}/voice_mapping.json', 'DATA')]

        pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

        exe = EXE(
            pyz,
            a.scripts,
            a.binaries,
            a.zipfiles,
            a.datas,
            [],
            name='LOTRO_Voice_Companion',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            upx_exclude=[],
            runtime_tmpdir=None,
            console=False, 
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
            icon={icon_str}, 
        )
        """

        # 3. Spec Datei schreiben
        with open('main.spec', 'w', encoding='utf-8') as f:
            f.write(spec_content)
        
        print("--- MAIN.SPEC INHALT ---")
        print(spec_content)
        print("------------------------")

        # 4. PyInstaller starten
        PyInstaller.__main__.run(['main.spec', '--clean', '--noconfirm'])
        "@
        
        $scriptContent | Out-File -FilePath builder.py -Encoding utf8
        python builder.py
      shell: pwsh

    - name: üìÇ Pr√ºfen und Umbenennen
      run: |
        if (Test-Path "dist/LOTRO_Voice_Companion.exe") {
            Write-Host "Build erfolgreich! Datei gefunden."
        } else {
            Write-Error "FEHLER: EXE wurde nicht erstellt."
            exit 1
        }
      shell: pwsh

    - name: üì§ Artefakt hochladen
      uses: actions/upload-artifact@v4
      with:
        name: LOTRO-Voice-Companion-Windows-EXE
        path: dist/LOTRO_Voice_Companion.exe
