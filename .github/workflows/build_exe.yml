name: üî® Build Windows Executable (Final Fix)

on:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'

jobs:
  build_windows_exe:
    runs-on: windows-latest
    
    steps:
    - name: üì• Repository auschecken
      uses: actions/checkout@v4

    - name: üêç Python Setup (Version ${{ env.PYTHON_VERSION }})
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ‚öôÔ∏è Systemabh√§ngigkeiten installieren
      run: |
        pip install pyinstaller
        pip install -r requirements.txt

    - name: üõ†Ô∏è Build-Skript (Absolute Pfade)
      run: |
        $scriptContent = @"
        import PyInstaller.__main__
        import os
        import sys

        # 1. Den absoluten Pfad zum Arbeitsverzeichnis ermitteln
        # Das verhindert, dass PyInstaller Dateien "√ºbersieht"
        work_dir = os.path.abspath(os.getcwd())
        print(f'--- ARBEITSVERZEICHNIS: {work_dir} ---')

        # 2. Alle deine Python-Module finden (automatisches Hidden-Import)
        hidden_imports = []
        files_found = []
        
        for f in os.listdir(work_dir):
            if f.endswith('.py') and f != 'main.py' and f != 'builder.py':
                name = f[:-3] # .py Endung entfernen
                hidden_imports.append(f'--hidden-import={name}')
                files_found.append(name)
        
        print(f'Gefundene Module f√ºr Import: {files_found}')

        # 3. Icon Einbindung (mit absolutem Pfad)
        icon_args = []
        icon_path = os.path.join(work_dir, 'app_icon.ico')
        if os.path.exists(icon_path):
            print(f'ICON GEFUNDEN: {icon_path}')
            icon_args = [f'--icon={icon_path}']
        else:
            print('WARNUNG: app_icon.ico nicht gefunden! Standard-Icon wird genutzt.')

        # 4. Der PyInstaller Befehl
        # --paths={work_dir} ist der wichtigste Teil gegen den Import-Fehler!
        args = [
            os.path.join(work_dir, 'main.py'),
            '--onefile',
            '--name=LOTRO_Voice_Companion',
            f'--paths={work_dir}',           # Zwingt PyInstaller, hier zu suchen
            '--collect-all=pygame',
            '--clean',
            '--noconfirm',
            '--windowed'                     # --windowed = Kein schwarzes Konsolenfenster
        ] + hidden_imports + icon_args

        print('--- STARTE PYINSTALLER ---')
        PyInstaller.__main__.run(args)
        "@
        
        # Skript speichern und ausf√ºhren
        $scriptContent | Out-File -FilePath builder.py -Encoding utf8
        python builder.py
      shell: pwsh

    - name: üìÇ Pr√ºfen und Umbenennen
      run: |
        if (Test-Path "dist/LOTRO_Voice_Companion.exe") {
            Write-Host "Build erfolgreich! Datei gefunden."
        } else {
            Write-Error "FEHLER: EXE wurde nicht erstellt."
            exit 1
        }
      shell: pwsh

    - name: üì§ Artefakt hochladen
      uses: actions/upload-artifact@v4
      with:
        name: LOTRO-Voice-Companion-Windows-EXE
        path: dist/LOTRO_Voice_Companion.exe
